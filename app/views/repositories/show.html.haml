%main.container.mx-auto.px-4.py-8.max-w-6xl
  .bg-white.rounded-lg.shadow-sm.p-6.mb-6
    %header.mb-6
      .flex.items-start.justify-between
        %div
          %h2.text-2xl.font-bold.mb-1= @repository.name
          %p.text-gray-600
            = link_to @repository.url, @repository.url, target: '_blank', class: 'text-blue-600 hover:underline text-sm'
        - if @repository.analyzed_at.present?
          %p.text-sm.text-gray-500
            解析日時: #{l(@repository.analyzed_at, format: :long)}

  - if @repository.status.pending? || @repository.status.analyzing?
    .bg-blue-50.rounded-lg.p-6.mb-6{ data: { controller: 'reload', reload_interval_value: 3000 } }
      %h3.text-lg.font-semibold.mb-2.text-blue-800 解析中...
      %p.text-blue-600
        Gemfile.lockを解析しています。しばらくお待ちください。
      .mt-4
        .animate-pulse.flex.space-x-4
          .h-2.bg-blue-400.rounded.w-full

  - elsif @repository.status.failed?
    .bg-red-50.rounded-lg.p-6.mb-6
      %h3.text-lg.font-semibold.mb-2.text-red-800 解析に失敗しました
      %p.text-red-600
        解析中にエラーが発生しました。リポジトリのURLを確認してください。

  - else
    - if @repository.current_rails_version.present?
      .bg-white.rounded-lg.shadow-sm.p-6.mb-6{ data: { controller: 'rails-upgrade', rails_upgrade_current_version_value: @repository.current_rails_version } }
        %h3.text-lg.font-semibold.mb-4 Rails バージョン
        .flex.items-center.gap-4.flex-wrap
          %span.font-mono.text-lg.bg-gray-100.px-3.py-1.rounded= @repository.current_rails_version
          %span.text-gray-400 →
          = select_tag :target_rails_version, options_for_select([['アップグレード先を選択', '']] + @repository.available_target_versions.map { |v| [v, v] }), class: 'border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent', data: { rails_upgrade_target: 'select', action: 'change->rails-upgrade#updateLinks' }

        .mt-4.hidden.bg-gray-50.rounded-lg.p-4{ data: { rails_upgrade_target: 'links' } }
          %h4.font-semibold.mb-3.text-sm.text-gray-600 アップグレード参考リンク
          %ul.space-y-2
            %li.flex.items-center.gap-2
              %span.text-gray-500.text-sm Railsdiff:
              = link_to '', '', target: '_blank', class: 'text-blue-600 hover:underline text-sm', data: { rails_upgrade_target: 'railsdiffLink' }
            %li.flex.items-center.gap-2
              %span.text-gray-500.text-sm Railsアップグレードガイド:
              = link_to 'ガイドを開く', 'https://guides.rubyonrails.org/upgrading_ruby_on_rails.html', target: '_blank', class: 'text-blue-600 hover:underline text-sm'

    .bg-white.rounded-lg.shadow-sm.p-6
      %h3.text-lg.font-semibold.mb-4 Gem差分一覧

      - if @repository.gem_reports.any?
        .overflow-x-auto
          %table.w-full.border-collapse
            %thead
              %tr.border-b-2.border-gray-200
                %th.px-4.py-3.text-left.text-sm.font-semibold.text-gray-600 gem名
                %th.px-4.py-3.text-left.text-sm.font-semibold.text-gray-600 現バージョン
                %th.px-4.py-3.text-left.text-sm.font-semibold.text-gray-600 最新バージョン
                %th.px-4.py-3.text-left.text-sm.font-semibold.text-gray-600 差分
                %th.px-4.py-3.text-left.text-sm.font-semibold.text-gray-600 リンク
            %tbody
              - @repository.gem_reports.default_order.each do |gem_report|
                %tr.border-b.hover:bg-gray-50.transition-colors
                  %td.px-4.py-3
                    = link_to gem_report.name, [@repository, gem_report], class: 'text-blue-600 hover:underline font-medium'
                  %td.px-4.py-3.font-mono.text-sm= gem_report.current_version
                  %td.px-4.py-3.font-mono.text-sm= gem_report.latest_version.presence || '-'
                  %td.px-4.py-3
                    = render 'repositories/version_diff_label', gem_report: gem_report
                  %td.px-4.py-3
                    .flex.items-center.gap-2
                      - if gem_report.changelog_url.present?
                        = link_to 'Changelog', gem_report.changelog_url, target: '_blank', class: 'text-xs text-blue-600 hover:underline'
                      - if gem_report.source_code_url.present?
                        = link_to 'Source', gem_report.source_code_url, target: '_blank', class: 'text-xs text-blue-600 hover:underline'
      - else
        .text-center.py-8
          %p.text-gray-500 まだ解析されていません。
